<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Houston Traffic Slider Demo</title>
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body {margin:0;font-family:sans-serif;}
    #map {position: absolute; top: 60px; bottom: 0; width: 100%;}
    #topbar {position:absolute; top:0; left:0; right:0; height:60px;
             background:#222; color:#fff; display:flex; align-items:center;
             padding:0 1rem; gap:1rem;}
    #kpi {font-size:1.2rem; font-weight:bold;}
  </style>
</head>
<body>

<div id="topbar">
  Traffic multiplier:
  <input id="slider" type="range" min="0.5" max="1.5" value="1" step="0.1">
  <span id="factor">1.0×</span> |
  <span id="kpi">Loading…</span>
</div>
<div id="map"></div>

<!-- LIBRARIES -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@duckdb/duckdb-wasm@1.27.1/dist/duckdb-browser-eh.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.3/papaparse.min.js"></script>

<script>
(async () => {
  /* 1.  Kick off Leaflet */
  const map = L.map('map').setView([29.76,-95.37], 10);   // downtown Houston
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
              {attribution:'©OSM'}).addTo(map);

  /* 2.  Load the CSV and push into DuckDB */
  const csvText = await fetch('txdot_counts_hou.csv').then(r=>r.text());
  const rows = Papa.parse(csvText, {header:true, dynamicTyping:true}).data;

  // spin up DuckDB in the browser
  const JS = await duckdb.selectBundle(duckdb.getJsDelivrBundles());
  const db = new duckdb.AsyncDuckDB(jsDelivrBundles=JS);
  await db.instantiate();
  const conn = await db.connect();
  await conn.insertJSON({
      name:'counts',
      rows
  });

  /* 3. Create Leaflet layer */
  const circles = L.layerGroup().addTo(map);
  function drawCircles(mult=1){
    circles.clearLayers();
    rows.forEach(r=>{
      const val = r.AADT_RPT_QTY * mult;
      if(!Number.isFinite(val)) return;
      const radius = Math.sqrt(val)/5;   // simple scaling
      const c = L.circleMarker([r.LATITUDE, r.LONGITUDE], {
        radius,
        color:'#ff6600',
        weight:1,
        fillOpacity:0.6
      }).bindTooltip(`AADT: ${Math.round(val).toLocaleString()}`);
      circles.addLayer(c);
    });
  }

  /* 4. KPI calculator */
  async function updateKPI(mult=1){
    const {rows:[{total}]} = await conn.query(`
      SELECT SUM("AADT") * ${mult} AS total FROM counts
    `);
    document.getElementById('kpi').textContent =
      'Total daily vehicles: ' +
       Math.round(total).toLocaleString();
  }

  /* 5.  Hook up the slider */
  const slider = document.getElementById('slider');
  slider.addEventListener('input', e=>{
     const mult = parseFloat(e.target.value);
     document.getElementById('factor').textContent = mult.toFixed(1)+'×';
     drawCircles(mult);
     updateKPI(mult);
  });

  drawCircles(1);
  updateKPI(1);
})();
</script>
</body>
</html>
